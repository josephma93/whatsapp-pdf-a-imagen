<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PDF a imagen para grupo de WhatsApp</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 24px; max-width: 1100px; }
    h1 { margin: 0 0 12px; font-size: 22px; }
    .row { display: flex; flex-wrap: wrap; gap: 12px; align-items: end; margin: 12px 0 18px; }
    label { display: grid; gap: 6px; font-size: 14px; }
    input[type="number"], select {
      width: 170px; padding: 8px 10px; border: 1px solid #ccc; border-radius: 10px; font-size: 14px;
    }
    input[type="file"] { font-size: 14px; }
    button {
      padding: 10px 14px; border: 1px solid #ccc; border-radius: 12px; background: #fff; cursor: pointer;
      font-size: 14px;
    }
    button:disabled { opacity: .5; cursor: not-allowed; }
    .canvases { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; align-items: start; }
    .panel { border: 1px solid #e5e5e5; border-radius: 14px; padding: 14px; }
    .panel h2 { margin: 0 0 10px; font-size: 16px; }
    canvas { width: 100%; height: auto; background: #fafafa; border-radius: 12px; }
    .meta { font-size: 13px; color: #444; margin-top: 10px; line-height: 1.35; }
    a.download { display: inline-block; margin-top: 10px; font-size: 14px; }
  </style>
</head>
<body>
  <h1>PDF a imagen para grupo de WhatsApp</h1>

  <div class="row">
    <label>
      PDF
      <input id="pdfFile" type="file" accept="application/pdf" />
    </label>

    <label>
      Página
      <input id="pageNumber" type="number" min="1" value="1" />
    </label>

    <label>
      Tamaño final cuadrado
      <select id="outputSize">
        <option value="1200" selected>1200 × 1200</option>
        <option value="1080">1080 × 1080</option>
        <option value="900">900 × 900</option>
      </select>
    </label>

    <label>
      Calidad de render
      <select id="renderScale">
        <option value="1.5">Media</option>
        <option value="2.0" selected>Alta</option>
        <option value="2.5">Muy alta</option>
      </select>
    </label>

    <button id="generateBtn" disabled>Generar PNG</button>
  </div>

  <div class="canvases">
    <div class="panel">
      <h2>Render del PDF (referencia)</h2>
      <canvas id="pdfCanvas"></canvas>
      <div class="meta" id="pdfMeta"></div>
    </div>

    <div class="panel">
      <h2>Imagen final para grupo</h2>
      <canvas id="outCanvas"></canvas>
      <div class="meta" id="outMeta"></div>
      <div class="row">
        <a id="downloadLink" class="download" href="#" download="whatsapp_grupo.png" style="display:none;">Descargar PNG</a>
        <button id="shareBtn" type="button" style="display:none;">Compartir</button>
      </div>
    </div>
  </div>

  <script type="module">
    import * as pdfjsLib from "https://cdn.jsdelivr.net/npm/pdfjs-dist@5.4.530/build/pdf.mjs";

    pdfjsLib.GlobalWorkerOptions.workerSrc =
      "https://cdn.jsdelivr.net/npm/pdfjs-dist@5.4.530/build/pdf.worker.mjs";

    const pdfFile = document.getElementById("pdfFile");
    const pageNumberEl = document.getElementById("pageNumber");
    const outputSizeEl = document.getElementById("outputSize");
    const renderScaleEl = document.getElementById("renderScale");
    const generateBtn = document.getElementById("generateBtn");

    const pdfCanvas = document.getElementById("pdfCanvas");
    const outCanvas = document.getElementById("outCanvas");

    const pdfMeta = document.getElementById("pdfMeta");
    const outMeta = document.getElementById("outMeta");
    const downloadLink = document.getElementById("downloadLink");
    const shareBtn = document.getElementById("shareBtn");

    if (outputSizeEl) {
      outputSizeEl.value = "1200";
      outputSizeEl.disabled = true;
    }

    let pdfData = null; // Uint8Array estable
    let shareFile = null;

    if (!navigator.share) {
      shareBtn.style.display = "none";
    }

    pdfFile.addEventListener("change", async () => {
      const file = pdfFile.files?.[0];
      downloadLink.style.display = "none";
      shareBtn.style.display = "none";
      shareFile = null;
      pdfMeta.textContent = "";
      outMeta.textContent = "";
      if (!file) {
        pdfData = null;
        generateBtn.disabled = true;
        return;
      }

      const buf = await file.arrayBuffer();
      pdfData = new Uint8Array(buf); // <- clave: guardamos Uint8Array
      generateBtn.disabled = false;
    });

    generateBtn.addEventListener("click", async () => {
      if (!pdfData) return;

      downloadLink.style.display = "none";
      pdfMeta.textContent = "Cargando…";
      outMeta.textContent = "";

      const pageNumber = Math.max(1, Number(pageNumberEl.value || 1));
      const outputSide = 1200;
      const renderScale = Number(renderScaleEl.value);

      // <- clave: copiamos para evitar detached buffer
      const dataCopy = new Uint8Array(pdfData);

      const pdfDoc = await pdfjsLib.getDocument({ data: dataCopy }).promise;
      const page = await pdfDoc.getPage(pageNumber);

      const viewport = page.getViewport({ scale: renderScale });
      const ctx = pdfCanvas.getContext("2d", { alpha: false });

      pdfCanvas.width = Math.floor(viewport.width);
      pdfCanvas.height = Math.floor(viewport.height);

      await page.render({ canvasContext: ctx, viewport }).promise;

      const srcW = pdfCanvas.width;
      const srcH = pdfCanvas.height;

      pdfMeta.textContent = `PDF render: ${srcW}×${srcH}px | página: ${pageNumber} | escala: ${renderScale}`;

      // Modelo WhatsApp: recorte cuadrado lado = min(w,h)
      const side = Math.min(srcW, srcH);

      // Para que el PDF completo quepa dentro del cuadrado:
      // Escalamos uniformemente hasta que el ancho del PDF sea "side"
      // y lo centramos en un lienzo cuadrado, generando padding horizontal.
      const scaleToSquare = side / srcW;
      const fitW = Math.round(srcW * scaleToSquare);
      const fitH = Math.round(srcH * scaleToSquare);

      const outCtx = outCanvas.getContext("2d", { alpha: false });
      outCanvas.width = outputSide;
      outCanvas.height = outputSide;

      outCtx.fillStyle = "#ffffff";
      outCtx.fillRect(0, 0, outputSide, outputSide);

      const scaleFinal = outputSide / side;
      const drawW = Math.round(fitW * scaleFinal);
      const drawH = Math.round(fitH * scaleFinal);

      const dx = Math.round((outputSide - drawW) / 2);
      const dy = Math.round((outputSide - drawH) / 2);

      outCtx.imageSmoothingEnabled = true;
      outCtx.imageSmoothingQuality = "high";
      outCtx.drawImage(pdfCanvas, 0, 0, srcW, srcH, dx, dy, drawW, drawH);

      outMeta.textContent =
        `Salida: ${outputSide}×${outputSide}px | lado cuadrado WhatsApp=${side}px | PDF→cuadrado: ${(side/srcW*100).toFixed(1)}% del ancho`;

      const pngUrl = outCanvas.toDataURL("image/png");
      downloadLink.href = pngUrl;
      downloadLink.style.display = "inline-block";

      const pngBlob = await new Promise((resolve) =>
        outCanvas.toBlob(resolve, "image/png")
      );
      if (pngBlob) {
        shareFile = new File([pngBlob], "whatsapp_grupo.png", { type: "image/png" });
        if (navigator.share && (!navigator.canShare || navigator.canShare({ files: [shareFile] }))) {
          shareBtn.style.display = "inline-block";
        }
      }

      // opcional: liberar recursos
      await pdfDoc.destroy();
    });

    shareBtn.addEventListener("click", async () => {
      if (!shareFile || !navigator.share) return;
      try {
        await navigator.share({
          title: "WhatsApp grupo",
          text: "Imagen generada desde PDF",
          files: [shareFile],
        });
      } catch (err) {
        // usuario canceló o la app no permite compartir
      }
    });
  </script>
</body>
</html>
